<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Summary: Building AI Solutions with Azure ML</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="While studying for the Azure Data Scientist Associate certification, I took notes from Building AI Solution with Azure ML course. In this single..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Marco Santoni</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">about</a></li>
                    <li><a href="/pages/atacmonitor.html">atacmonitor</a></li>
                    <li><a href="/pages/bookshelf.html">bookshelf</a></li>
                    <li class="active"><a href="/category/posts.html">posts</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/summary_building_ai_solutions_azure_ml.html" rel="bookmark"
           title="Permalink to Summary: Building AI Solutions with Azure ML">Summary: Building AI Solutions with Azure ML</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-08-19T06:41:00+02:00">
                Published: Wed 19 August 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/marco-santoni.html">Marco Santoni</a>
        </address>
<p>In <a href="/category/posts.html">posts</a>.</p>

</footer><!-- /.post-info -->      <p>While studying for the <em>Azure Data Scientist Associate</em> certification, I took notes from <a href="https://docs.microsoft.com/en-us/learn/paths/build-ai-solutions-with-azure-ml-service/">Building AI Solution with Azure ML</a> course. In this single page, you'll find the entire content of the course (as of 18th August, 2020). This page is a small support for those preparing for earning the certification.</p>
<h1>Intro</h1>
<h2>Azure ML Workspace</h2>
<p>workspaces are azure resources. include:</p>
<ul>
<li>compute</li>
<li>notebooks</li>
<li>pipelines</li>
<li>data</li>
<li>experiments</li>
<li>models</li>
</ul>
<p>created alongside</p>
<ul>
<li>storage account: files by WS + data</li>
<li>application insights</li>
<li>key vault</li>
<li>vm</li>
<li>container registry</li>
</ul>
<p>permission: RBAC</p>
<p>edition
- basic (no graphic designer)
- enterprise</p>
<h2>Tools</h2>
<p>Azure ML Studio
- designer (no code ML model dev)
- automated ML</p>
<p>Azure ML SDK</p>
<p>Azure ML CLI Extensions</p>
<p>Compute Instances
- choose VM
- store notebooks independently of VMs</p>
<p>VS Code - Azure ML Extension</p>
<h2>Experiments</h2>
<p>Azure ML tracks run of experiments</p>
<div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">start_logging</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">run</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>logging metrics. <code>run.log('name', value)</code>. You can review them via <code>RunDetails(run).show()</code></li>
<li>experiment output file. Example: trained models. <code>run.upload_file(..)</code>.</li>
</ul>
<p><strong>Script as an experiment</strong>. In the script, you can get the context: <code>run = Rune.get_context()</code>. To run it, you define:</p>
<ul>
<li>RunConfiguration: python environment</li>
<li>ScriptRunConfig: associates RunConfiguration with script</li>
</ul>
<h1>Train a ML model</h1>
<h2>Estimators</h2>
<p>Estimator: encapsulates a run configuration and a script configuration in a single object. Save trained model as pickle in <code>outputs</code> folder</p>
<div class="highlight"><pre><span></span><code><span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
  <span class="n">conda_packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scikit-learn&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_experiment&#39;</span><span class="p">)</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">estimator</span><span class="p">)</span>
</code></pre></div>


<p>Framework-specific estimators simplify configurations</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">azureml.train.sklearn</span> <span class="kn">import</span> <span class="n">SKLearn</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;local&#39;</span>
<span class="p">)</span>
</code></pre></div>


<h2>Script parameters</h2>
<p>Use <code>argparse</code> to read the parameters in a script (eg regularization rate). To pass a parameter to an <code>Estimator</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training.py&#39;</span><span class="p">,</span>
  <span class="n">script_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;--reg_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;local&#39;</span>
<span class="p">)</span>
</code></pre></div>


<h2>Registering models</h2>
<p>Once the experiment <code>Run</code> has completed, you can retrieve its outputs (eg trained model).</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputs/models.pkl&#39;</span><span class="p">,</span> <span class="n">output_file_path</span><span class="o">=</span><span class="s1">&#39;model.pkl&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Registering a model allows to track multiple versions of a model.</p>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;classification_model&#39;</span><span class="p">,</span>
  <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;model.pkl&#39;</span><span class="p">,</span> <span class="c1">#local path</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;a classification model&#39;</span><span class="p">,</span>
  <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dept&#39;</span><span class="p">:</span> <span class="s1">&#39;sales&#39;</span><span class="p">},</span>
  <span class="n">model_framework</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">Framework</span><span class="o">.</span><span class="n">SCIKITLEARN</span><span class="p">,</span>
  <span class="n">model_framework_version</span><span class="o">=</span><span class="s1">&#39;0.20.3&#39;</span>
<span class="p">)</span>
</code></pre></div>


<p>or register from run:</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span>
  <span class="o">...</span>
  <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;outputs/model.pkl&#39;</span>
  <span class="o">...</span>
  <span class="p">)</span>
</code></pre></div>


<h1>Datastores</h1>
<p>Abstractions of cloud data sources encapsulating the information required to connect.</p>
<p>You can register a data store</p>
<ul>
<li>via ML Studio</li>
<li>via SDK</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">ws</span> <span class="o">=</span> <span class="n">Workspace</span><span class="o">.</span><span class="n">from_config</span><span class="p">()</span>
<span class="n">blob</span> <span class="o">=</span> <span class="n">Datastore</span><span class="o">.</span><span class="n">register_azure_blob_container</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">datastore_name</span><span class="o">=</span><span class="s1">&#39;blob_data&#39;</span><span class="p">,</span>
  <span class="n">container_name</span><span class="o">=</span><span class="s1">&#39;data_container&#39;</span><span class="p">,</span>
  <span class="n">account_name</span><span class="o">=</span><span class="s1">&#39;az_acct&#39;</span><span class="p">,</span>
  <span class="n">account_key</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>
<span class="p">)</span>
</code></pre></div>


<p>In the SDK, you can list data stores.</p>
<h2>Use datastores</h2>
<p>Most common: Azure blob and file</p>
<div class="highlight"><pre><span></span><code><span class="n">blob_ds</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
  <span class="n">src_dir</span><span class="o">=</span><span class="s1">&#39;/files&#39;</span><span class="p">,</span>
  <span class="n">target_path</span><span class="o">=</span><span class="s1">&#39;/data/files&#39;</span><span class="p">,</span>
  <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">blob_ds</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
  <span class="n">target_path</span><span class="o">=</span><span class="s1">&#39;downloads&#39;</span><span class="p">,</span>
  <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;/data&#39;</span>
<span class="p">)</span>
</code></pre></div>


<p>You pass a data reference to the script to use a datastore. Data access models</p>
<ul>
<li>download: contents downloaded to the compute context of experiment</li>
<li>upload: files generated by experiment are uploaded after run</li>
<li>mount: path of datastore mounted as remote storage (only on remote compute target)</li>
</ul>
<p>Pass reference as script parameter:</p>
<div class="highlight"><pre><span></span><code><span class="n">data_ref</span> <span class="o">=</span> <span class="n">blob_ds</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;data/files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_download</span><span class="p">(</span><span class="n">path_on_compute</span><span class="o">=</span><span class="s1">&#39;training_data&#39;</span><span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment_folder&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training_script.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
  <span class="n">script_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;--data_folder&#39;</span><span class="p">:</span> <span class="n">data_ref</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>


<p>Retrieve it in script and use it like local folder:</p>
<div class="highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data_folder&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;data_folder&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">)</span>
</code></pre></div>


<h2>Datasets</h2>
<p>Datasets are versioned packaged data objects consumed in experiments and pipelines. Types</p>
<ul>
<li>tabular: read as table</li>
<li>file: list of file paths</li>
</ul>
<p>You can create dataset via Azure ML Studio or via SDK. File paths can have wildcards (<code>/files/*.csv</code>).</p>
<p>Once a dataset is created, you can <strong>register</strong> it in the workspace (available later too).</p>
<p>Tabular:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">azureml.core</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">blob_ds</span> <span class="o">=</span> <span class="n">we</span><span class="o">.</span><span class="n">get_default_datastore</span><span class="p">()</span>
<span class="n">csv_paths</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="n">blob_ds</span><span class="p">,</span> <span class="s1">&#39;data/files/current_data.csv&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="n">blob_ds</span><span class="p">,</span> <span class="s1">&#39;data/files/archive/*.csv&#39;</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">tab_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">Tabular</span><span class="o">.</span><span class="n">from_delimited_files</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">csv_paths</span><span class="p">)</span>
<span class="n">tab_ds</span> <span class="o">=</span> <span class="n">tab_ds</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;csv_table&#39;</span><span class="p">)</span>
</code></pre></div>


<p>File:</p>
<div class="highlight"><pre><span></span><code><span class="n">blob_ds</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">get_default_datastore</span><span class="p">()</span>
<span class="n">file_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="n">blob_ds</span><span class="p">,</span> <span class="s1">&#39;data/files/images/*.jpg&#39;</span><span class="p">))</span>
<span class="n">file_ds</span> <span class="o">=</span> <span class="n">file_ds</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img_files&#39;</span><span class="p">)</span>
</code></pre></div>


<p><strong>Retrieve</strong> a dataset</p>
<div class="highlight"><pre><span></span><code><span class="n">ws</span> <span class="o">=</span> <span class="n">Workspace</span><span class="o">.</span><span class="n">from_config</span><span class="p">()</span>

<span class="c1"># Get a dataset from workspace datasets collection</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;csv_table&#39;</span><span class="p">]</span>

<span class="c1"># Get a dataset by name from the datasets class</span>
<span class="n">ds2</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s1">&#39;img_files&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Datasets can be <strong>versioned</strong>. Create a new versioning by registering with same name and <code>create_new_version</code> property:</p>
<div class="highlight"><pre><span></span><code><span class="n">file_ds</span> <span class="o">=</span> <span class="n">file_ds</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img_files&#39;</span><span class="p">,</span> <span class="n">create_new_version</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<p>Retrieve specific version:</p>
<div class="highlight"><pre><span></span><code><span class="n">img_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img_files&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>


<h1>Compute Contexts</h1>
<p>The runtime context for each experiment consists of</p>
<ul>
<li><em>environment</em> for the script, which includes all packages</li>
<li><em>compute target</em> on which the environment will be deployed</li>
</ul>
<h2>Intro to Environments</h2>
<p>Python runs in virtual environments (eg <code>Conda</code>, <code>pip</code>). Azure creates a Docker container and creates the environment. You create environments by</p>
<ul>
<li><code>Conda</code> or <code>pip</code> yaml file and load it:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">from_conda_specification</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_env&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;./conda.yml&#39;</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>from existing <code>Conda</code> environment:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">from_conda_environment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_env&#39;</span><span class="p">,</span>
                            <span class="n">conda_environment_name</span><span class="o">=</span><span class="s1">&#39;py_env&#39;</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>specifying packages:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="s1">&#39;training_env&#39;</span><span class="p">)</span>
<span class="n">deps</span> <span class="o">=</span> <span class="n">CondaDependencies</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conda_packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">]</span>
                              <span class="n">pip_packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;azureml-defaults&#39;</span><span class="p">])</span>
<span class="n">env</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span> <span class="o">=</span> <span class="n">deps</span>
</code></pre></div>


<p>Once created, you can register the environment in the workspace.</p>
<div class="highlight"><pre><span></span><code><span class="n">env</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span>
</code></pre></div>


<p>Retrieve and assign it to a <code>ScriptRunConfig</code> or an <code>Estimator</code></p>
<div class="highlight"><pre><span></span><code><span class="n">tr_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_env&#39;</span><span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment_folder&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training_script.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
  <span class="n">environment_definition</span><span class="o">=</span><span class="n">tr_env</span>
  <span class="p">)</span>
</code></pre></div>


<h2>Compute targets</h2>
<p>Compute targets are physical or virtual computer on which experiments are run. Types of compute</p>
<ul>
<li><em>local compute</em>: your workstation or a virtual machine</li>
<li><em>compute clusters</em>: multi-node clusters of VMs that automatically scale up or down</li>
<li><em>inference clusters</em>: to deploy models, they use containers to initiate computing</li>
<li><em>attached compute</em>: attach a VM or Databricks cluster that you already use</li>
</ul>
<p>You can create a compute target via AML studio or via SDK. A <strong>managed</strong> compute target is one managed by AML. Via SDK</p>
<div class="highlight"><pre><span></span><code><span class="n">ws</span> <span class="o">=</span> <span class="n">Workspace</span><span class="o">.</span><span class="n">from_config</span><span class="p">()</span>
<span class="n">compute_name</span> <span class="o">=</span> <span class="s1">&#39;aml-cluster&#39;</span>
<span class="n">compute_config</span> <span class="o">=</span> <span class="n">AmlCompute</span><span class="o">.</span><span class="n">provisioning_configuration</span><span class="p">(</span>
  <span class="n">vm_size</span><span class="o">=</span><span class="s1">&#39;STANDARD_DS12_V2&#39;</span><span class="p">,</span>
  <span class="n">min_nodes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">max_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
  <span class="n">vm_priority</span><span class="o">=</span><span class="s1">&#39;dedicated&#39;</span>
  <span class="p">)</span>
<span class="n">aml_cluster</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">we</span><span class="p">,</span> <span class="n">compute_name</span><span class="p">,</span> <span class="n">compute_config</span><span class="p">)</span>
<span class="n">aml_cluster</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">()</span>
</code></pre></div>


<p>An <strong>unmanaged</strong> compute target is defined and managed outside AML. You can attach it via SDK:</p>
<div class="highlight"><pre><span></span><code><span class="n">ws</span> <span class="o">=</span> <span class="n">Workspace</span><span class="o">.</span><span class="n">from_config</span><span class="p">()</span>
<span class="n">compute_name</span> <span class="o">=</span> <span class="s1">&#39;db-cluster&#39;</span>
<span class="n">db_workspace_name</span> <span class="o">=</span> <span class="s1">&#39;db_workspace&#39;</span>
<span class="n">db_resource_group</span> <span class="o">=</span> <span class="s1">&#39;db_resource_group&#39;</span>
<span class="n">db_access_token</span> <span class="o">=</span> <span class="s1">&#39;aocsinaocnasoivn&#39;</span>
<span class="n">db_config</span> <span class="o">=</span> <span class="n">DatabricksCompute</span><span class="o">.</span><span class="n">attach_configuration</span><span class="p">(</span>
  <span class="n">resource_group</span><span class="o">=</span><span class="n">db_resource_group</span><span class="p">,</span>
  <span class="n">workspace_name</span><span class="o">=</span><span class="n">db_workspace_name</span><span class="p">,</span>
  <span class="n">access_token</span><span class="o">=</span><span class="n">db_access_token</span>
  <span class="p">)</span>
<span class="n">db_cluster</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">we</span><span class="p">,</span> <span class="n">compute_name</span><span class="p">,</span> <span class="n">db_config</span><span class="p">)</span>
<span class="n">db_cluster</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">()</span>
</code></pre></div>


<p>You can check if a compute target does not exist already:</p>
<div class="highlight"><pre><span></span><code><span class="n">compute_name</span> <span class="o">=</span> <span class="s1">&#39;aml_cluster&#39;</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">aml_cluster</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">compute_name</span><span class="p">)</span>
<span class="k">except</span> <span class="n">ComputeTargetException</span><span class="p">:</span>
  <span class="c1"># create it</span>
  <span class="o">...</span>
</code></pre></div>


<p>You can use a compute target in an experiment run by specifying it as a parameter</p>
<div class="highlight"><pre><span></span><code><span class="n">compute_name</span> <span class="o">=</span> <span class="s1">&#39;aml_cluster&#39;</span>
<span class="n">training_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_env&#39;</span><span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment_folder&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training_script.py&#39;</span><span class="p">,</span>
  <span class="n">environment_definition</span><span class="o">=</span><span class="n">training_env</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="n">compute_name</span>
  <span class="p">)</span>
<span class="c1"># or specify a ComputeTarget object</span>
<span class="n">training_cluster</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">compute_name</span><span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;experiment_folder&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;training_script.py&#39;</span><span class="p">,</span>
  <span class="n">environment_definition</span><span class="o">=</span><span class="n">training_env</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="n">training_cluster</span>
  <span class="p">)</span>
</code></pre></div>


<h1>Orchestrating with Pipelines</h1>
<p>A <em>pipeline</em> is a workflow of ml tasks in which each tasks is implemented as a <em>step</em> (either sequential or parallel). You can combine different compute targets. Common types of step:</p>
<ul>
<li><em>PythonScriptStep</em></li>
<li><em>EstimatorStep</em>: runs an estimator</li>
<li><em>DataTransferStep</em>: uses ADF</li>
<li><em>DatabricksStep</em></li>
<li><em>AdlaStep</em>: runs a <code>U-SQL</code> job in Azure Data Lake Analytics</li>
</ul>
<p>Define steps:</p>
<div class="highlight"><pre><span></span><code><span class="n">step1</span> <span class="o">=</span> <span class="n">PythonScriptStep</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prepare data&#39;</span><span class="p">,</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;scripts&#39;</span><span class="p">,</span>
  <span class="n">script_name</span><span class="o">=</span><span class="s1">&#39;data_prep.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;aml-cluster&#39;</span><span class="p">,</span>
  <span class="n">runconfig</span><span class="o">=</span><span class="n">run_config</span>
  <span class="p">)</span>

<span class="n">step2</span> <span class="o">=</span> <span class="n">EstimatorStep</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train model&#39;</span><span class="p">,</span>
  <span class="n">estimator</span><span class="o">=</span><span class="n">sk_estimator</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;aml-cluster&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<p>Assign steps to pipeline:</p>
<div class="highlight"><pre><span></span><code><span class="n">train_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">step1</span><span class="p">,</span><span class="n">step2</span><span class="p">]</span>
  <span class="p">)</span>
<span class="c1"># create experiment and run pipeline</span>
<span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;training-pipeline&#39;</span><span class="p">)</span>
<span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">train_pipeline</span><span class="p">)</span>
</code></pre></div>


<h2>Pass data between steps</h2>
<p>The <code>PipelineData</code> object is a special kind of <code>DataReference</code> that</p>
<ul>
<li>reference a location in a store</li>
<li>creates a da dependency between pipelines</li>
</ul>
<p>To pass it</p>
<ul>
<li>define a <code>PipelineData</code> object that references a location in a data store</li>
<li>specify the object as input or output for the steps that use it</li>
<li>pass the <code>PipelineData</code> object as a script parameter in steps that run scripts</li>
</ul>
<p>Example</p>
<div class="highlight"><pre><span></span><code><span class="n">raw_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s1">&#39;raw_dataset&#39;</span><span class="p">)</span>
<span class="c1"># Define object to pass data between steps</span>
<span class="n">data_store</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">get_default_datastore</span><span class="p">()</span>
<span class="n">prepped_data</span> <span class="o">=</span> <span class="n">PipelineData</span><span class="p">(</span><span class="s1">&#39;prepped&#39;</span><span class="p">,</span> <span class="n">datastore</span><span class="o">=</span><span class="n">data_store</span><span class="p">)</span>

<span class="n">step1</span> <span class="o">=</span> <span class="n">PythonScriptStep</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prepare data&#39;</span><span class="p">,</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;scripts&#39;</span><span class="p">,</span>
  <span class="n">script_name</span><span class="o">=</span><span class="s1">&#39;data_prep.py&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;aml-cluster&#39;</span><span class="p">,</span>
  <span class="n">runconfig</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
  <span class="c1"># specify dataset</span>
  <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_ds</span><span class="o">.</span><span class="n">as_named_input</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)],</span>
  <span class="c1"># specify PipelineData as output</span>
  <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">prepped_data</span><span class="p">],</span>
  <span class="c1"># script reference</span>
  <span class="n">arugments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--folder&#39;</span><span class="p">,</span> <span class="n">prepped_data</span><span class="p">]</span>
  <span class="p">)</span>

<span class="n">step2</span> <span class="o">=</span> <span class="n">EstimatorStep</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train model&#39;</span><span class="p">,</span>
  <span class="n">estimator</span><span class="o">=</span><span class="n">sk_estimator</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;aml-cluster&#39;</span>
  <span class="c1"># specify PipelineData</span>
  <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">prepped_data</span><span class="p">],</span>
  <span class="c1"># pass reference to estimator script</span>
  <span class="n">estimator_entry_script_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--folder&#39;</span><span class="p">,</span> <span class="n">prepped_data</span><span class="p">]</span>
  <span class="p">)</span>
</code></pre></div>


<p>Inside the script, you can get reference to <code>PipelineData</code> object from the argument, and use it like  a local folder.</p>
<div class="highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n">argpare</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--folder&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;folder&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">folder</span>

<span class="c1"># ...</span>

<span class="c1"># save data to PipelineData location</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;prepped_data.csv&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</code></pre></div>


<h2>Reuse steps</h2>
<p>By default, the step output from a previous pipeline run is reused without rerunning the step (if script, source directory and other params have not changed). You can control this:</p>
<div class="highlight"><pre><span></span><code><span class="n">step1</span> <span class="o">=</span> <span class="n">PythonScriptStep</span><span class="p">(</span>
  <span class="c1">#...</span>
  <span class="n">allow_reuse</span><span class="o">=</span><span class="kc">False</span>
  <span class="p">)</span>
</code></pre></div>


<p>You can force the steps to run regardless of individual configuration:</p>
<div class="highlight"><pre><span></span><code><span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">train_pipeline</span><span class="p">,</span> <span class="n">regenerate_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<h2>Publish pipelines</h2>
<p>You can publish a pipelien to create a REST endpoint through which the pipeline can be run on demand.</p>
<div class="highlight"><pre><span></span><code><span class="n">published_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_pipeline&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Model training pipeline&#39;</span><span class="p">,</span>
  <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<p>You can view it in ML Studio and get the endpoint:</p>
<div class="highlight"><pre><span></span><code><span class="n">published_pipeline</span><span class="o">.</span><span class="n">endpoint</span>
</code></pre></div>


<p>You start a published endpoint by making an HTTP request to it. You pass the authorisation header (with token) and a JSON payload specifying the experiment name. The pipeline is run asynchronously, you get the run ID as response.</p>
<h2>Pipeline parameters</h2>
<p>Create a <code>PipelineParameter</code> object for each parameter. Example:</p>
<div class="highlight"><pre><span></span><code><span class="n">reg_param</span> <span class="o">=</span> <span class="n">PipelineParameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;reg_rate&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="c1"># ...</span>
<span class="n">step2</span> <span class="o">=</span> <span class="n">EstimatorStep</span><span class="p">(</span>
  <span class="c1"># ...</span>
  <span class="n">estimator_entry_script_arguments</span><span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;--folder&#39;</span><span class="p">,</span> <span class="n">prepped</span><span class="p">,</span>
    <span class="s1">&#39;--reg&#39;</span><span class="p">,</span> <span class="n">reg_param</span>
  <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>


<p>After you publish a parametrised pipeline, you can pass parameter values in the JSON payload of the REST interface. Example</p>
<div class="highlight"><pre><span></span><code><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
  <span class="n">enpoint</span><span class="p">,</span>
  <span class="n">headers</span><span class="o">=</span><span class="n">auth_header</span><span class="p">,</span>
  <span class="n">json</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;ExperimentName&#39;</span><span class="p">:</span> <span class="s1">&#39;run_training_pipeline&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ParameterAssignments&#39;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">&#39;reg_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="p">)</span>
</code></pre></div>


<h2>Schedule pipelines</h2>
<p>Define a <code>ScheduleRecurrence</code> and use it to create a <code>Schedule</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">daily</span> <span class="o">=</span> <span class="n">ScheduleRecurrence</span><span class="p">(</span>
  <span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span>
  <span class="n">interval</span><span class="o">=</span><span class="mi">1</span>
  <span class="p">)</span>
<span class="n">pipeline_schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="n">ws</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Daily Training&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;train model every day&#39;</span><span class="p">,</span>
  <span class="n">pipeline_id</span><span class="o">=</span><span class="n">published_pipeline</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">experiment_name</span><span class="o">=</span><span class="s1">&#39;Training_Pipeline&#39;</span><span class="p">,</span>
  <span class="n">recurrence</span><span class="o">=</span><span class="n">daily</span>
  <span class="p">)</span>
</code></pre></div>


<p>To schedule a pipeline to run whenever <strong>data changes</strong>, you must create a <code>Schedule</code> that monitors a specific path on a datastore:</p>
<div class="highlight"><pre><span></span><code><span class="n">training_datastore</span> <span class="o">=</span> <span class="n">Datastore</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;blob_data&#39;</span><span class="p">)</span>
<span class="n">pipeline_schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="c1"># ...</span>
  <span class="n">datastore</span><span class="o">=</span><span class="n">training_datastore</span><span class="p">,</span>
  <span class="n">path_on_datastore</span><span class="o">=</span><span class="s1">&#39;data/training&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<h1>Deploy ML Models</h1>
<p>You can deploy ass <strong>container</strong> to several compute targets</p>
<ul>
<li>Azure ML compute instance</li>
<li>Azure container instance</li>
<li>Azure function</li>
<li>Azure Kubernetes service</li>
<li>IoT module</li>
</ul>
<p>Steps</p>
<ol>
<li>register the model</li>
<li>inference configuration</li>
<li>deployment configuration</li>
<li>deploy model</li>
</ol>
<h2><a name="registermodel"></a>Register the model</h2>
<p>After training, you must register the model to Azure ML workspace.</p>
<div class="highlight"><pre><span></span><code><span class="n">classification_model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;classification_model&#39;</span><span class="p">,</span>
  <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;model.pkl&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A classification model&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<p>Or you can use the reference to the run:</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span>
  <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;classification_model&#39;</span><span class="p">,</span>
  <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;outputs/model.pkl&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A classification model&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<h2><a name="scoringscript"></a>Inference configuration</h2>
<p>The model will be deployed as a service consisting of</p>
<ul>
<li>a script to load the model and return predictions for submitted data</li>
<li>an environment in which the script will be run</li>
</ul>
<p>Create the <em>entry script</em> (or <em>scoring script</em>) as a Python file including 2 functions</p>
<ul>
<li><code>init()</code> called when service is initialised (load model from registry)</li>
<li><code>run(raw_data)</code> called when new data is submitted to the service (generate predictions)</li>
</ul>
<p>Example</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">model</span>
  <span class="n">model_path</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="s1">&#39;classification_model&#39;</span><span class="p">)</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="c1"># return predictions as any JSON seriazable format</span>
  <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>


<p>You can configure the environment using Conda. You can use a <code>CondaDependencies</code> class to create a default environment (including <code>azureml-defaults</code> and other commonly-used) and add any other required packages. You then serialize the environment to a string and save it.</p>
<div class="highlight"><pre><span></span><code><span class="n">myenv</span> <span class="o">=</span> <span class="n">CondaDependencies</span><span class="p">()</span>
<span class="n">myenv</span><span class="o">.</span><span class="n">add_conda_package</span><span class="p">(</span><span class="s1">&#39;scikit-learn&#39;</span><span class="p">)</span>

<span class="n">env_file</span> <span class="o">=</span> <span class="s1">&#39;service_files/env.yml&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">myenv</span><span class="o">.</span><span class="n">serialize_to_string</span><span class="p">())</span>
</code></pre></div>


<p>After creating the script and the environment, you combine them in an <code>InferenceConfig</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">classifier_inference_config</span> <span class="o">=</span> <span class="n">InferenceConfig</span><span class="p">(</span>
  <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;service_files&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;score.py&#39;</span><span class="p">,</span>
  <span class="n">conda_file</span><span class="o">=</span><span class="s1">&#39;env.yml&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<h2>Deployment configuration</h2>
<p>Now that you have the entry script and the environment, you configure the compute service. If you deploy to an AKS cluster, you create it</p>
<div class="highlight"><pre><span></span><code><span class="n">cluster_name</span> <span class="o">=</span> <span class="s1">&#39;aks-cluster&#39;</span>
<span class="n">compute_config</span> <span class="o">=</span> <span class="n">AksCompute</span><span class="o">.</span><span class="n">provisioning_configuration</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;eastus&#39;</span><span class="p">)</span>
<span class="n">production_cluster</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">,</span> <span class="n">compute_config</span><span class="p">)</span>
<span class="n">production_cluster</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">()</span>
</code></pre></div>


<p>You define the deployment configuration</p>
<div class="highlight"><pre><span></span><code><span class="n">classifier_deploy_config</span> <span class="o">=</span> <span class="n">AksWebservice</span><span class="o">.</span><span class="n">deploy_configuration</span><span class="p">(</span>
  <span class="n">cpu_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">memory_gb</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>


<h2>Deploy the model</h2>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;classification_model&#39;</span><span class="p">]</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;classification-service&#39;</span><span class="p">,</span>
  <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">],</span>
  <span class="n">inference_config</span><span class="o">=</span><span class="n">classifier_inference_config</span><span class="p">,</span>
  <span class="n">deploy_config</span><span class="o">=</span><span class="n">classifier_deploy_config</span><span class="p">,</span>
  <span class="n">deployment_target</span><span class="o">=</span><span class="n">production_cluster</span>
  <span class="p">)</span>
<span class="n">service</span><span class="o">.</span><span class="n">wait_for_deployment</span><span class="p">()</span>
</code></pre></div>


<h2>Consuming a real-time inferencing service</h2>
<p>For <strong>testing</strong>, you can use the AML SDK to call a web service through the <code>run</code> method of a <code>WebService</code> object. Typically,  you send data to <code>run</code> method in a JSON like</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="s1">&#39;data&#39;</span><span class="p">:[</span>
    <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>


<p>The response is a JSON with a prediction for each case</p>
<div class="highlight"><pre><span></span><code><span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>


<p>In <strong>production</strong>, you use a REST endpoint. You find the endpoint of a deployed service in Azure ML studio, or by retrieving the <code>scoring_url</code> property of a <code>Webservice</code> object:</p>
<div class="highlight"><pre><span></span><code><span class="n">endpoint</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">scoring_uri</span>
</code></pre></div>


<p>There are 2 kinds of <strong>authentication</strong>:</p>
<ul>
<li>key: requests are authenticated by specifying the key associated with the service</li>
<li>token: requests are authenticated by providing a JSON Web Token (JWT)</li>
</ul>
<p>By default, authentication is disabled for Azure Container Instance service (set to key-based authentication for AKS).</p>
<p>To make an authenticate call to the REST endpoint, you include the oey or the token in the request header.</p>
<h2>Troubleshooting service deployment</h2>
<p>You can</p>
<ul>
<li>check the service state (should be <em>healty</em>): <code>service.state</code></li>
<li>review service logs: <code>service.get_logs()</code></li>
<li>deploy to local container</li>
</ul>
<h1>Batch inference pipelines</h1>
<p>Pipeline to read input data, load a registered model, predict labels, and write results.</p>
<ol>
<li><a href="#registermodel">Register</a> a model</li>
<li>Create a <a href="#scoringscript">scoring script</a>. The <code>run(mini_batch)</code> method makes the inference on each batch.</li>
<li>Create a pipeline with ParallelRunStep</li>
<li>Run the pipeline and retrieve the step output</li>
</ol>
<p>Azure ML provides a pipeline step performs parallel batch inference. Using <code>ParallelRunStep</code> class, you can read batches of files from a <code>File</code> dataset and write the output to a <code>PipelineData</code> reference. You can set the <code>output_action</code> to <em>"append_row"</em> (ensuring all instances of the step will collate the result to a single output file named <code>parallel_run_step.txt</code>).</p>
<div class="highlight"><pre><span></span><code><span class="n">batch_data_set</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">datasets</span><span class="p">(</span><span class="s1">&#39;batch-data&#39;</span><span class="p">)</span>

<span class="c1"># output location</span>
<span class="n">default_ds</span> <span class="o">=</span> <span class="n">we</span><span class="o">.</span><span class="n">get_default_datastore</span><span class="p">()</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">PipelineData</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inferences&#39;</span><span class="p">,</span>
  <span class="n">datastore</span><span class="o">=</span><span class="n">default_ds</span><span class="p">,</span>
  <span class="n">output_path_on_compute</span><span class="o">=</span><span class="s1">&#39;results&#39;</span>
<span class="p">)</span>

<span class="n">parallel_run_config</span> <span class="o">=</span> <span class="n">ParallelRunConfig</span><span class="p">(</span>
  <span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;batch_scripts&#39;</span><span class="p">,</span>
  <span class="n">entry_script</span><span class="o">=</span><span class="s1">&#39;batch_scoring_script.py&#39;</span><span class="p">,</span>
  <span class="n">mini_batch_size</span><span class="o">=</span><span class="s2">&quot;5&quot;</span><span class="p">,</span>
  <span class="n">error_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
  <span class="n">output_action</span><span class="o">=</span><span class="s2">&quot;append_row&quot;</span><span class="p">,</span>
  <span class="n">environment</span><span class="o">=</span><span class="n">batch_env</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="n">aml_cluster</span><span class="p">,</span>
  <span class="n">node_count</span><span class="o">=</span><span class="mi">4</span>
  <span class="p">)</span>

<span class="n">parallelrun_step</span> <span class="o">=</span> <span class="n">ParallelRunStep</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;batch-score&quot;</span><span class="p">,</span>
  <span class="n">parallel_run_config</span><span class="o">=</span><span class="n">parallel_run_config</span><span class="p">,</span>
  <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">batch_data_set</span><span class="o">.</span><span class="n">as_named_input</span><span class="p">(</span><span class="s1">&#39;batch_data&#39;</span><span class="p">)],</span>
  <span class="n">output</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
  <span class="n">arguments</span><span class="o">=</span><span class="p">[],</span>
  <span class="n">allow_reuse</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">parallelrun_step</span><span class="p">]</span>
  <span class="p">)</span>
</code></pre></div>


<p>Run the pipeline and retrieve output.</p>
<div class="highlight"><pre><span></span><code><span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s1">&#39;batch_prediction_pipeline&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
<span class="n">pipeline_run</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">()</span>

<span class="n">prediction_run</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">get_children</span><span class="p">())</span>
<span class="n">prediction_output</span> <span class="o">=</span> <span class="n">prediction_run</span><span class="o">.</span><span class="n">get_output_data</span><span class="p">(</span><span class="s1">&#39;inferences&#39;</span><span class="p">)</span>
<span class="n">prediction_output</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
</code></pre></div>


<h2>Publishing a batch inference pipeline</h2>
<p>You can publish it as a <strong>REST</strong> service.</p>
<div class="highlight"><pre><span></span><code><span class="n">published_pipeline</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">publish_pipeline</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Batch_Prediction_Pipeline&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Batch Pipeline&#39;</span><span class="p">,</span>
  <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span>
  <span class="p">)</span>

<span class="n">rest_endpoint</span> <span class="o">=</span> <span class="n">published_pipeline</span><span class="o">.</span><span class="n">endpoint</span>
</code></pre></div>


<p>Once published, you can use the endpoint to initiate a batch inferencing job.</p>
<p>You can also <strong>schedule</strong> the published pipeline to have it run automatically.</p>
<div class="highlight"><pre><span></span><code><span class="n">weekly</span> <span class="o">=</span> <span class="n">ScheduleRecurrence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;Week&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pipeline_schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="n">ws</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Weekly Predictions&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;batch inferencing&#39;</span><span class="p">,</span>
  <span class="n">pipeline_id</span><span class="o">=</span><span class="n">published_pipeline</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">experiment_name</span><span class="o">=</span><span class="s1">&#39;Batch_Prediction&#39;</span><span class="p">,</span>
  <span class="n">recurrence</span><span class="o">=</span><span class="n">weekly</span>
  <span class="p">)</span>
</code></pre></div>


<h1>Tuning hyperparameters</h1>
<p>Accomplished by training multiple models, using same algorithm and training data but different hyperparameter values. Then, evaluate for each the performance metric (eg accuracy), and the best-performing model is selected.</p>
<p>In Azure ML, you make an experiment that consist of a <em>hyperdrive</em> run, which initiates a child run for each hyperparameter. Each child run uses a training script with parametrised hyperparameter values to train a model, and logs the target performance metric achieved by the training model.</p>
<h2>Define a search space</h2>
<p>Depends on the type of hyperparameter:</p>
<ul>
<li><strong>discrete</strong>. Make a <code>choice</code> out of</li>
<li>an explicit python <code>list</code>: <code>choice([10, 20, 30])</code></li>
<li>a <code>range</code>: <code>choice(range(1,10))</code></li>
<li>select values from a discrete distribution: <em>qnormal, quniform, qlognormal, qloguniform</em></li>
<li><strong>continuous</strong>. Use any of these distribution: <em>normal, uniform, lognormal, loguniform</em></li>
</ul>
<p>Define a search space by creating a dictionary with parameter expressions for each hyperparameter.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">azureml.train.hyperdrive</span> <span class="kn">import</span> <span class="n">choice</span><span class="p">,</span> <span class="n">normal</span>

<span class="n">param_space</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;--batch_size&#39;</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
  <span class="s1">&#39;--learning_rate&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>


<h2>Configuring sampling</h2>
<p>The values used in a tuning run depend on the type of <em>sampling</em> used.</p>
<p><strong>Grid sampling.</strong> Every possible combination when hyperparameters are discrete.</p>
<div class="highlight"><pre><span></span><code><span class="n">param_space</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;--batch_size&#39;</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
  <span class="s1">&#39;--learning_rate&#39;</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">param_sampling</span> <span class="o">=</span> <span class="n">GridParameterSampling</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
</code></pre></div>


<p><strong>Random sampling.</strong> Randomly select a value for each hyperparameter.</p>
<div class="highlight"><pre><span></span><code><span class="n">param_space</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;--batch_size&#39;</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
  <span class="s1">&#39;--learning_rate&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">param_sampling</span> <span class="o">=</span> <span class="n">RandomParameterSampling</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
</code></pre></div>


<p><strong>Bayesian sampling.</strong> Based on Bayesian optimisation algorithm that tries to select parameter combinations that will result in improved performance from the previous selection.</p>
<div class="highlight"><pre><span></span><code><span class="n">param_space</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;--batch_size&#39;</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
  <span class="s1">&#39;--learning_rate&#39;</span><span class="p">:</span> <span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">param_sampling</span> <span class="o">=</span> <span class="n">BayesianParameterSampling</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
</code></pre></div>


<p>Can only be used with <em>choice, uniform, quniform</em> distributions and can't be combined with <em>early termination</em>.</p>
<h2>Configuring an early termination</h2>
<p>Typically, you set a maximum number of iterations, but this could still result in a large number of runs that don't result in a better model than a combination that has already been tried.</p>
<p>To help preventing wasting time, you can set an <em>early termination</em> policy that abandons runs that are unlikely to produce a better result than previously completed runs. The policy is evaluated at an <em>evaluation interval</em> you specify, based on each time the target performance metric is logged. You can also set a <em>delay evaluation</em> parameter to avoid evaluating the policy until a minimum number of iterations have been completed.</p>
<p><strong>Note.</strong> Early termination is particularly useful for deep learning scenarios where a deep neural network is trained iteratively over a number of epochs. The training script can report the target metric after each epoch, and if the run is significantly underperforming previous runs after the same number of intervals, it can be abandoned.</p>
<p><strong>Bandit policy.</strong> Stop a run if the target performance metric underperforms the best run so far by a specified margin.</p>
<div class="highlight"><pre><span></span><code><span class="n">early_termination_policy</span> <span class="o">=</span> <span class="n">BanditPolicy</span><span class="p">(</span>
  <span class="n">slack_amount</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="c1"># abandon runs when metric is 0.2 or more worse than best run after the same number of intervals</span>
  <span class="n">evaluation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">delay_evaluation</span><span class="o">=</span><span class="mi">5</span>
  <span class="p">)</span>
</code></pre></div>


<p>You can also use a slack <em>factor</em> comparing the metric as ration rather than an absolute value.</p>
<p><strong>Median stopping policy.</strong> Abandoning runs where the target performance metric is worse than the median of the running averages fo all runs.</p>
<div class="highlight"><pre><span></span><code><span class="n">early_termination_policy</span> <span class="o">=</span> <span class="n">MedianStoppingPolicy</span><span class="p">(</span>
  <span class="n">evaluation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">delay_evaluation</span><span class="o">=</span><span class="mi">5</span>
  <span class="p">)</span>
</code></pre></div>


<p><strong>Truncation selection policy.</strong> Cancelling the lower performing <em>X%%</em> of runs at each evaluation interval  based on the <em>truncation_percentage</em> valu you specify for <em>X</em>.</p>
<div class="highlight"><pre><span></span><code><span class="n">early_termination_policy</span> <span class="o">=</span> <span class="n">TruncationSelectionPolicy</span><span class="p">(</span>
  <span class="n">truncation_percentage</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
  <span class="n">evaluation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">delay_evaluation</span><span class="o">=</span><span class="mi">5</span>
  <span class="p">)</span>
</code></pre></div>


<h2>Running a hyperparameter tuning experiment</h2>
<p>In Azure ML, you tune hyper by running a <em>hyperdrive</em> experiment. You need to create a training script just the way you would do for any other training experiment, except that you <strong>must</strong>:</p>
<ul>
<li>include an argument for each hyperparameter</li>
<li>log the target performance metric.</li>
</ul>
<p>This example script trains a logistic regression using a <code>--regularization</code> argument (regularization rate), and logs the <em>accuracy</em>.</p>
<div class="highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--regularization&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;reg_rate&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">reg</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reg_rate</span>

<span class="c1"># get experiment run context</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">Run</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">input_datasets</span><span class="p">[</span><span class="s1">&#39;training_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas_dataframe</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;feature1&#39;</span><span class="p">,</span> <span class="s1">&#39;feature2&#39;</span><span class="p">,</span> <span class="s1">&#39;feature3&#39;</span><span class="p">,</span> <span class="s1">&#39;feature4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">reg</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># calculate and log accuracy</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y_hat</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>

<span class="c1"># save trained model</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;outputs/model.pkl&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
</code></pre></div>


<p>To prepare the hyperdrive experiment, you use a <code>HyperDriveConfig</code> object to configure the experiment run.</p>
<div class="highlight"><pre><span></span><code><span class="n">hyperdrive</span> <span class="o">=</span> <span class="n">HyperDriveConfig</span><span class="p">(</span>
  <span class="n">estimator</span><span class="o">=</span><span class="n">sklearn_estimator</span><span class="p">,</span>
  <span class="n">hyperparameter_sampling</span><span class="o">=</span><span class="n">param_sampling</span><span class="p">,</span>
  <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">primary_metric_name</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span>
  <span class="n">primary_metricgoal</span><span class="o">=</span><span class="n">PrimaryMetricGoal</span><span class="o">.</span><span class="n">MAXIMIZE</span><span class="p">,</span>
  <span class="n">max_total_runs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
  <span class="n">max_concurrent_runs</span><span class="o">=</span><span class="mi">4</span>
  <span class="p">)</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hyperdrive_training&#39;</span><span class="p">)</span>
<span class="n">hyperdrive_run</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">hyperdrive</span><span class="p">)</span>
</code></pre></div>


<p>You can monitor hyperdrive experiment in Azure ML studio. The experiment will initiate a child run for each hyperparameter combination to be tried</p>
<h1>Automate model selection</h1>
<p>Visual interface for automated ML in Azure ML Studio for <em>Enterprise</em> edition only.</p>
<p>You can use automated ML to train models for the tasks below. Azure ML supports common algorithms for these tasks:</p>
<ul>
<li>classification</li>
<li>logistic regression</li>
<li>light gradient boosting machine</li>
<li>decision tree</li>
<li>random forest</li>
<li>naive Bayes</li>
<li>linear SVM</li>
<li>XGBoost</li>
<li>DNN classifier</li>
<li>others...</li>
<li>regression</li>
<li>linear regression</li>
<li>light gradient boosting machine</li>
<li>decision tree</li>
<li>random forest</li>
<li>elastic net</li>
<li>LARS Lasso</li>
<li>XGBoost</li>
<li>Others</li>
<li>time series forecasting</li>
<li>linear regression</li>
<li>light gradient boosting machine</li>
<li>decision tree</li>
<li>random forest</li>
<li>elastic net</li>
<li>LARS Lasso</li>
<li>XGBoost</li>
<li>others</li>
</ul>
<p>By default, automated machine learning, will randomly select from the full range of algorithms for the specified task. You can choose to <strong>block</strong> individual algorithms from being selected.</p>
<h2>Preprocessing and featurization</h2>
<p>Automated ML (AutoML) can apply preprocessing transformations to your data.</p>
<ul>
<li><strong>scaling and normalization</strong> applied to numeric data <strong>automatically</strong></li>
<li><strong>optional featurization</strong></li>
<li>missing value imputation</li>
<li>categorical encoding</li>
<li>dropping high cardinality features (eg IDs)</li>
<li>feature engineering (eg date parts from DateTime)</li>
</ul>
<h2>Running AutoML experiment</h2>
<p>You can use Auzure ML Studio UI or use SDK (using <code>AutoMLConfig</code> class).</p>
<div class="highlight"><pre><span></span><code><span class="n">automl_run_config</span> <span class="o">=</span> <span class="n">RunConfiguration</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="n">automl_config</span> <span class="o">=</span> <span class="n">AutoMLConfig</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;auto ml experiment&#39;</span><span class="p">,</span>
  <span class="n">task</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span>
  <span class="n">primary_metric</span><span class="o">=</span><span class="s1">&#39;AUC_weighted&#39;</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="n">aml_compute</span><span class="p">,</span>
  <span class="n">training_data</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
  <span class="n">validation_data</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span>
  <span class="n">label_column_name</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
  <span class="n">featurization</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
  <span class="n">iterations</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
  <span class="n">max_concurrent_iterations</span><span class="o">=</span><span class="mi">4</span>
  <span class="p">)</span>
</code></pre></div>


<p>With Azure ML Studio, you can create or select an Azure ML <em>dataset</em> to be used as input for your AutoML experiment. When using the SDK, you can submit data by</p>
<ul>
<li>specify a dataset or dataframe of <em>training data</em> that includes features and label to be predicted</li>
<li>optionally, specify a second <em>validation data</em> dataset or dataframe. If this is not provided, Azure ML will apply cross-validation.</li>
</ul>
<p>Alternatively:</p>
<ul>
<li>specify a dataset, dataframe, or numpy array of <em>X</em> values containing features with a corresponding <em>y</em> array of label values</li>
</ul>
<p>One of the most important setting you specify is <strong>primary_metric</strong> (ie target performance metric). Azure ML supports a set of named metrics for each type of task.</p>
<div class="highlight"><pre><span></span><code><span class="n">get_primary_metrics</span><span class="p">(</span><span class="s1">&#39;classification&#39;</span><span class="p">)</span>
</code></pre></div>


<p>You can <strong>submit</strong> an AutoML experiment like any other SDK-based experiment:</p>
<div class="highlight"><pre><span></span><code><span class="n">automl_experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s1">&#39;automl_experiment&#39;</span><span class="p">)</span>
<span class="n">automl_run</span> <span class="o">=</span> <span class="n">automl_experiment</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">automl_config</span><span class="p">)</span>
</code></pre></div>


<p>You can easily identify the best run in Auzre ML studio, and download or deploy the model it generated. Via SDK:</p>
<div class="highlight"><pre><span></span><code><span class="n">best_run</span><span class="p">,</span> <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">automl_run</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
<span class="n">best_run_metrics</span> <span class="o">=</span> <span class="n">best_run</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">()</span>
<span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">best_run_metrics</span><span class="p">:</span>
  <span class="n">metric</span> <span class="o">=</span> <span class="n">best_run_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
</code></pre></div>


<p>AutoML uses <em>scikit-learn</em> pipelines. You can view the steps in the fitted model you obtained from the best run.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div>


<h1>Explain ML models</h1>
<p>Model explainers use statistical techniques to calculate <strong>feature importance</strong>. Explainers work by evaluating a test data set of feature cases and the labels the model predicts for them.</p>
<p><strong>Global feature importance</strong> quantifies the relative importance of each feature in the test dataset as a whole: which feature in the dataset influences prediction?</p>
<p><strong>Local feature importance</strong> measures the influence of each feature value for a specific individual prediction. Example, will Sam go deafult?</p>
<blockquote>
<p>Prediction=0: Samuel won't default on the loan repayment</p>
</blockquote>
<p>Features:</p>
<ul>
<li><em>loan amount</em>; support for 0: <code>0.9</code>; support for 1: <code>-0.9</code></li>
<li><em>income</em>; support for 0: <code>0.6</code></li>
<li><em>age</em>; support for 0: <code>-0.2</code></li>
<li><em>marital status</em>; support for 0: <code>0.1</code></li>
</ul>
<p>Because this is a <em>classification</em> model, each feature gets a local importance value for each possible class, indicating the amount of support for that class based on the feature value.</p>
<p>The most important feature for a prediction of class 1 is <em>loan amount</em>. There could be multiple reasons why local importance for an individualprediction varies form global importance for the overall dataset. For example, Sam might have a lower income than average, but the loan amount in this case might be unusually small.</p>
<p>For a multi-class classification model, a local importance value for each possible class is calculated for every feature, with the total across all classes always being 0.</p>
<p>For a <strong>regression model</strong>, the local importance values simply indicate the level of influence each feature has on the predicted scalar label.</p>
<h2>Using explainers</h2>
<p>You can use Azure ML SDK to create explainers for models even if they were not trained using an Azure ML experiment.</p>
<p>You install the <code>azureml-interpret</code> package. Types of explainer include:</p>
<ul>
<li><code>MimicExplainer</code> creates a <em>global surrogate model</em> that approximates your trained model and can be used to generate explanations. This explainable model must have the same kind of architecture as your trained model (eg linear or tree-based)</li>
<li><code>TabularExplainer</code> acts as a wrapper around various SHAP explainer algorithms, automatically choosing the one that is most appropriate for your model architecture</li>
<li><code>PFIExplainer</code> (<em>Permutation Feature Importance</em>) analyzes feature importance by shuffling feature values and measuring the impact on prediction performance</li>
</ul>
<p>Example for hypothetical model named <code>loan_model</code></p>
<div class="highlight"><pre><span></span><code><span class="n">mim_explainer</span> <span class="o">=</span> <span class="n">MimicExplainer</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="n">loan_model</span><span class="p">,</span>
  <span class="n">initialization_examples</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
  <span class="n">explainable_model</span><span class="o">=</span><span class="n">DecisionTreeExplainableModel</span><span class="p">,</span>
  <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_amount&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;marital_status&#39;</span><span class="p">],</span>
  <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="s1">&#39;approve&#39;</span><span class="p">]</span>
  <span class="p">)</span>

<span class="n">tab_explainer</span> <span class="o">=</span> <span class="n">TabularExplainer</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="n">loan_model</span><span class="p">,</span>
  <span class="n">initialization_examples</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
  <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_amount&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;marital_status&#39;</span><span class="p">],</span>
  <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="s1">&#39;approve&#39;</span><span class="p">]</span>
  <span class="p">)</span>

<span class="n">pfi_explainer</span> <span class="o">=</span> <span class="n">PFIExplainer</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="n">loan_model</span><span class="p">,</span>
  <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_amount&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;marital_status&#39;</span><span class="p">],</span>
  <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="s1">&#39;approve&#39;</span><span class="p">]</span>
  <span class="p">)</span>
</code></pre></div>


<p>To retrieve <strong>global feature importance</strong>, call the <code>explain_global()</code> method of your explainer, and then use the <code>get_feature_importance_dict()</code> method to get a dictionary of the feature importance values.</p>
<div class="highlight"><pre><span></span><code><span class="n">global_mim_explanation</span> <span class="o">=</span> <span class="n">mim_explainer</span><span class="o">.</span><span class="n">explain_global</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">global_mim_feature_importance</span> <span class="o">=</span> <span class="n">global_mim_explanation</span><span class="o">.</span><span class="n">get_feature_importance_dict</span><span class="p">()</span>

<span class="c1"># same as MimixExplainer</span>
<span class="n">global_tab_explanation</span> <span class="o">=</span> <span class="n">mim_explainer</span><span class="o">.</span><span class="n">explain_global</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">global_tab_feature_importance</span> <span class="o">=</span> <span class="n">global_tab_explanation</span><span class="o">.</span><span class="n">get_feature_importance_dict</span><span class="p">()</span>

<span class="c1"># requires actual labels</span>
<span class="n">global_pfi_explanation</span> <span class="o">=</span> <span class="n">mim_explainer</span><span class="o">.</span><span class="n">explain_global</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">global_pfi_feature_importance</span> <span class="o">=</span> <span class="n">global_pfi_explanation</span><span class="o">.</span><span class="n">get_feature_importance_dict</span><span class="p">()</span>
</code></pre></div>


<p>To retriev <strong>local feature importance</strong> from a <code>MimicExplainer</code> or a <code>TabularExplainer</code>, you must call the <code>explain_local()</code> specifying the subset of cases you want to explain. Then you use the <code>get_ranked_local_names()</code> and <code>get_ranked_local_values()</code> to retrieve dictionares.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># same for tab_explainer too</span>
<span class="n">local_mim_explanation</span> <span class="o">=</span> <span class="n">mim_explainer</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">local_mim_features</span> <span class="o">=</span> <span class="n">local_mim_explanation</span><span class="o">.</span><span class="n">get_ranked_local_names</span><span class="p">()</span>
<span class="n">local_mim_importance</span> <span class="o">=</span> <span class="n">local_mim_explanation</span><span class="o">.</span><span class="n">get_ranked_local_values</span><span class="p">()</span>
</code></pre></div>


<p><code>PFIExplainer</code> does not support local feature importance explanations.</p>
<h2>Creating explanations</h2>
<p>You can create an explainer and upload the explanation it generates to the run for later analysis.</p>
<p>To create an explanation for the <strong>experiment script</strong>, you'll need to ensure that the <code>azureml-interpret</code> and <code>azureml-contrib-interpret</code> packages are installed in the run environment. Then you can use these to create an explanation from your trained model and upload it to the run outputs.</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span> <span class="o">=</span> <span class="n">Run</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>

<span class="c1"># code to train model goes here</span>

<span class="c1"># get explanation</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">TabularExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">explanation</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_global</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># get an explanation client and upload the explanation</span>
<span class="n">explain_client</span> <span class="o">=</span> <span class="n">ExplanationClient</span><span class="o">.</span><span class="n">from_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
<span class="n">explain_client</span><span class="o">.</span><span class="n">upload_model_explanation</span><span class="p">(</span><span class="n">explanation</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Tabular Explanation&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
</code></pre></div>


<p>You can view the explanation you created for your model in the <em>Explanations</em> tab for the run in Azure ML Studio.</p>
<h2>Visualizing explanations</h2>
<p>Model explanations in Azure ML Studio include multiple visualizations that you can use to explore feature importance. Visualizations:</p>
<ul>
<li>global feature importance</li>
<li>summary importance: shows the distribution of individual importance values for each feature across the test dataset</li>
<li>local feature importance by selecting an individual data point</li>
</ul>
<h1>Monitor models</h1>
<p>You can use Application Insights to capture and review telemetry from models published with Azure ML. You must have an Application Insights resource associated with your Azure ML workspace.</p>
<p>When you create an Azure ML workspace, you can select an Application Insights resource. If you do not select an existing resource, a new one is created in the same resource group as your workspace.</p>
<p>When deploying a new real-time service, you can <strong>enable</strong> Application Insights in the deployment configuration for the service.</p>
<div class="highlight"><pre><span></span><code><span class="n">dep_config</span> <span class="o">=</span> <span class="n">AciWebservice</span><span class="o">.</span><span class="n">deploy_configuration</span><span class="p">(</span>
  <span class="n">cpu_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">memory_gb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">enable_app_insights</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
</code></pre></div>


<p>If you want to enable Application Insights for a service that is already deployed, you can modify the deployment configuration for AKS based services in the Azure portal.</p>
<h2>Capture and view telemetry</h2>
<p>Application Insights automatically captures any information written to the standard output and error logs, and provides a query capability to view data in these logs.</p>
<p>You can write any value to the standard output in the scoring script by using a <code>print</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - Predictions: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>


<p>Azure ML creates a <em>custom dimension</em> in the data model for the output you write.</p>
<p>Yuo can use the Log Analytics query interface for the Applcation Insights in the Azure portal. It supports a SQL-like query syntax.</p>
<h1>Monitor data drift</h1>
<p>Over time there may be trends that change the profile of the data, making your model less accurate. This change in data profiles between training and inferencing is known as <em>data drift</em>.</p>
<p>Azure ML supports data drift monitoring through the use of <em>datasets</em>. You can compare two registered datasets to detect data drift, or you can capture new feature data submitted to a deployed model service and compare it to the dataset with which the model was trained.</p>
<p>You register 2 datasets:</p>
<ul>
<li>a <em>baseline</em> dataset: original training data</li>
<li>a <em>target</em> dataset that will be compared to the baseline on time intervals. This dataset requires a column for each feature you want to compare, and a timestamp column</li>
</ul>
<p>You define a <em>dataset monitor</em> to detect data drift and trigger alerts if the rate of drift exceeds a specified threshold. You can create dataset monitors using Azure ML Studio or by using the <code>DataDriftDetector</code> class.</p>
<div class="highlight"><pre><span></span><code><span class="n">monitor</span> <span class="o">=</span> <span class="n">DataDriftDetector</span><span class="o">.</span><span class="n">create_from_datasets</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dataset-drift-monitor&#39;</span><span class="p">,</span>
  <span class="n">baseline_data_set</span><span class="o">=</span><span class="n">train_ds</span><span class="p">,</span>
  <span class="n">target_data_set</span><span class="o">=</span><span class="n">new_data_ds</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="s1">&#39;aml-cluster&#39;</span><span class="p">,</span>
  <span class="n">frequency</span><span class="o">=</span> <span class="s1">&#39;week&#39;</span><span class="p">,</span>
  <span class="n">feature_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;bmi&#39;</span><span class="p">],</span>
  <span class="n">latency</span><span class="o">=</span><span class="mi">24</span>
  <span class="p">)</span>
</code></pre></div>


<p>You can <em>backfill</em> to immediately compare baseline to existing data in target.</p>
<div class="highlight"><pre><span></span><code><span class="n">backfill</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">backfill</span><span class="p">(</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div>


<p>If you have <strong>deployed a model</strong> as a real-time web service, you can capture new inferencing data s it is submitted, and compare it to the original training data. It has the benefit of automatically collecting new target data as the deployed model is used.</p>
<p>You include the training dataset in the model registration to provide a baseline.</p>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
  <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;./model/model.pkl&#39;</span><span class="p">,</span>
  <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;mymodel&#39;</span><span class="p">,</span>
  <span class="n">datasets</span><span class="o">=</span><span class="p">[(</span><span class="n">Dataset</span><span class="o">.</span><span class="n">Scenario</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">)]</span>
  <span class="p">)</span>
</code></pre></div>


<p>You enable data collection for services in which the model is used. You use the <code>ModelDataCollector</code> class in each service's scoring script, writing code to capture data and predictions and write them to the data collector (which will store them in Azure blob storage).</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_collect</span><span class="p">,</span> <span class="n">predict_collect</span>
  <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;mymodel&#39;</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">model_name</span><span class="p">))</span>

  <span class="c1"># enable collection of data and predictions</span>
  <span class="n">data_collect</span> <span class="o">=</span> <span class="n">ModelDataCollector</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">designation</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;bmi&#39;</span><span class="p">]</span>
    <span class="p">)</span>
  <span class="n">predict_collect</span> <span class="o">=</span> <span class="n">ModelDataCollector</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">designation</span><span class="o">=</span><span class="s1">&#39;predictions&#39;</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

  <span class="n">data_collect</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">predict_collect</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>


<p>With the data collection code in place in the scoring script, you can enable data collection in the deployment configuration.</p>
<div class="highlight"><pre><span></span><code><span class="n">dep_config</span> <span class="o">=</span> <span class="n">AksWebservice</span><span class="o">.</span><span class="n">deploy_configuration</span><span class="p">(</span><span class="n">collect_model_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<p>You can configure <strong>data drift monitoring</strong> by using a <code>DataDriftDetector</code> class.</p>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;mymodel&#39;</span><span class="p">]</span>
<span class="n">datadrift</span> <span class="o">=</span> <span class="n">DataDriftDetector</span><span class="o">.</span><span class="n">create_from_model</span><span class="p">(</span>
  <span class="n">ws</span><span class="p">,</span>
  <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
  <span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
  <span class="n">services</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;my-svc&#39;</span><span class="p">],</span>
  <span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;Week&#39;</span>
  <span class="p">)</span>
</code></pre></div>


<h2>Scheduling alerts</h2>
<p>You can specify a threshold for the rate of data drift and an operator email for notifications.</p>
<p>Monitoring works by running a comparison at scheduled <strong>frequency</strong> (day, week, or month), and calculating data drift metrics for the features. For dataset monitors, you can specify a <strong>latency</strong> indicating the number of hours to allow for new data to be collected and added to the target dataset. For deployed model data drifts monitor, you can specify a <code>schedule_start</code> time value to indicate when the data drift run should start (if omitted, the run will start at the current time).</p>
<p>Data drift is measured using a calculated <em>magnitude</em> of change in the statistical distributions of feature values over time. You can configure a <strong>threshold</strong> for data drift magnitude.</p>
<div class="highlight"><pre><span></span><code><span class="n">alert_email</span> <span class="o">=</span> <span class="n">AlertConfiguration</span><span class="p">(</span><span class="s1">&#39;data_scientist@contoso.com&#39;</span><span class="p">)</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">DataDriftDetector</span><span class="o">.</span><span class="n">create_from_datasets</span><span class="p">(</span>
  <span class="n">ws</span><span class="p">,</span>
  <span class="s1">&#39;dataset-drift-detector&#39;</span><span class="p">,</span>
  <span class="n">baseline_data_set</span><span class="p">,</span>
  <span class="n">target_data_set</span><span class="p">,</span>
  <span class="n">compute_target</span><span class="o">=</span><span class="n">cpu_cluster</span><span class="p">,</span>
  <span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;Week&#39;</span><span class="p">,</span>
  <span class="n">latency</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
  <span class="n">drift_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
  <span class="n">alert_configuration</span><span class="o">=</span><span class="n">alert_email</span>
  <span class="p">)</span>
</code></pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://linkedin.com/in/msantoni">linkedin</a></li>
                            <li><a href="https://twitter.com/mrsantoni">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>